# Deploy Storybooks to GitHub Pages
name: Deploy Storybooks to Pages

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Build React ECharts Storybook
        run: npx nx build-storybook react-echarts

      - name: Build React Code Editor Storybook
        run: npx nx build-storybook react-code-editor

      - name: Build React Graphics Editor Storybook
        run: npx nx build-storybook react-graphics-editor

      - name: Build React Media Player Storybook
        run: npx nx build-storybook react-media-player

      - name: Organize Storybooks for Pages
        run: |
          mkdir -p dist/storybook
          mv dist/storybook/libs/react-echarts dist/storybook/react-echarts
          mv dist/storybook/libs/react-code-editor dist/storybook/react-code-editor
          mv dist/storybook/libs/react-graphics-editor dist/storybook/react-graphics-editor
          mv dist/storybook/libs/react-media-player dist/storybook/react-media-player

      - name: Create index.html with navigation
        run: |
          mkdir -p dist/storybook
          cat > dist/storybook/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Eddie Workspace - React Portfolio Storybooks</title>
            <style>
              body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                max-width: 800px;
                margin: 0 auto;
                padding: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                color: white;
              }
              .container {
                background: rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(10px);
                border-radius: 20px;
                padding: 40px;
                box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
                border: 1px solid rgba(255, 255, 255, 0.18);
              }
              h1 {
                text-align: center;
                margin-bottom: 10px;
                font-size: 2.5em;
                background: linear-gradient(45deg, #fff, #f0f0f0);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
              }
              .subtitle {
                text-align: center;
                opacity: 0.9;
                margin-bottom: 40px;
                font-size: 1.1em;
              }
              .library-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 20px;
                margin-top: 30px;
              }
              .library-card {
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.2);
                border-radius: 15px;
                padding: 25px;
                text-align: center;
                transition: transform 0.3s ease, box-shadow 0.3s ease;
                text-decoration: none;
                color: white;
                display: block;
              }
              .library-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
                background: rgba(255, 255, 255, 0.15);
              }
              .library-icon {
                font-size: 3em;
                margin-bottom: 15px;
                opacity: 0.9;
              }
              .library-title {
                font-size: 1.4em;
                font-weight: bold;
                margin-bottom: 10px;
              }
              .library-description {
                opacity: 0.9;
                line-height: 1.5;
              }
              .footer {
                text-align: center;
                margin-top: 40px;
                opacity: 0.7;
                font-size: 0.9em;
              }
            </style>
          </head>
          <body>
            <div class="container">
              <h1>ðŸŽ¨ Eddie Workspace</h1>
              <p class="subtitle">React Portfolio - Angular to React Migrations</p>

              <div class="library-grid">
                <a href="/react-echarts/" class="library-card">
                  <div class="library-icon">ðŸ“Š</div>
                  <div class="library-title">React ECharts</div>
                  <div class="library-description">
                    Data visualization library with line charts and customizable themes
                  </div>
                </a>

                <a href="/react-code-editor/" class="library-card">
                  <div class="library-icon">ðŸ’»</div>
                  <div class="library-title">React Code Editor</div>
                  <div class="library-description">
                    Python code editor with syntax highlighting and execution capabilities
                  </div>
                </a>

                <a href="/react-graphics-editor/" class="library-card">
                  <div class="library-icon">ðŸŽ¨</div>
                  <div class="library-title">React Graphics Editor</div>
                  <div class="library-description">
                    Vector graphics editor built with Paper.js (In Development)
                  </div>
                </a>

                <a href="/react-media-player/" class="library-card">
                  <div class="library-icon">ðŸŽ¬</div>
                  <div class="library-title">React Media Player</div>
                  <div class="library-description">
                    Media player supporting DASH, HLS, and MP4 with DRM
                  </div>
                </a>
              </div>

              <div class="footer">
                <p>Built with React 19, TypeScript, and Nx â€¢ Deployed with GitHub Pages</p>
                <p>View source on <a href="https://github.com/yuchuan1/eddie-workspace" style="color: white;">GitHub</a></p>
              </div>
            </div>
          </body>
          </html>
          EOF

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist/storybook

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
