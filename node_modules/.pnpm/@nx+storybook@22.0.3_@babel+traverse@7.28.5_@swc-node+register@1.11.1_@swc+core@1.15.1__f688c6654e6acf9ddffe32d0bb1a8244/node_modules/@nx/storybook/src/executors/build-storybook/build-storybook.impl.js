"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = buildStorybookExecutor;
const devkit_1 = require("@nx/devkit");
const utilities_1 = require("../../utils/utilities");
const semver_1 = require("semver");
async function buildStorybookExecutor(options, context) {
    (0, utilities_1.storybookConfigExistsCheck)(options.configDir, context.projectName);
    const storybookMajor = (0, utilities_1.storybookMajorVersion)();
    if (storybookMajor > 0 && storybookMajor <= 6) {
        throw (0, utilities_1.pleaseUpgrade)();
    }
    else if (storybookMajor === 7) {
        devkit_1.logger.warn(`Support for Storybook 7 is deprecated. Please upgrade to Storybook 8. See https://nx.dev/nx-api/storybook/generators/migrate-8 for more details.`);
    }
    const buildOptions = options;
    devkit_1.logger.info(`NX Storybook builder starting ...`);
    await runInstance(buildOptions);
    devkit_1.logger.info(`NX Storybook builder finished ...`);
    devkit_1.logger.info(`NX Storybook files available in ${buildOptions.outputDir}`);
    return { success: true };
}
async function runInstance(options) {
    const installedStorybookVersion = (0, utilities_1.getInstalledStorybookVersion)();
    const hasCoreServerInStorybookPackage = (0, semver_1.gte)(installedStorybookVersion, '8.2.0');
    const storybookCore = await (hasCoreServerInStorybookPackage
        ? Promise.resolve().then(() => require('storybook/internal/core-server')) : // This is needed for backwards compatibility - but we do not have the package installed in the nx repo
     Promise.resolve().then(() => require('@storybook/core-server')));
    const env = process.env.NODE_ENV ?? 'production';
    process.env.NODE_ENV = env;
    return storybookCore.build({
        ...options,
        mode: 'static',
    });
}
