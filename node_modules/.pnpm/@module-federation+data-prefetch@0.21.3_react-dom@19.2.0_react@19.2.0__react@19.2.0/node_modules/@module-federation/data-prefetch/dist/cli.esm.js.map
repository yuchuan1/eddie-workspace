{"version":3,"file":"cli.esm.js","sources":["../src/common/constant.ts","../src/common/node-utils.ts","../src/cli/index.ts"],"sourcesContent":["export const TEMP_DIR = '.mf';\n","import path from 'path';\nimport fs from 'fs-extra';\nexport const fileExistsWithCaseSync = (filepath) => {\n    const dir = path.dirname(filepath);\n    if (filepath === '/' || filepath === '.') {\n        return true;\n    }\n    const filenames = fs.readdirSync(dir);\n    if (filenames.indexOf(path.basename(filepath)) === -1) {\n        return false;\n    }\n    return fileExistsWithCaseSync(dir);\n};\nexport const fixPrefetchPath = (exposePath) => {\n    const pathExt = ['.js', '.ts'];\n    const extReg = /\\.(ts|js|tsx|jsx)$/;\n    if (extReg.test(exposePath)) {\n        return pathExt.map((ext) => exposePath.replace(extReg, `.prefetch${ext}`));\n    }\n    else {\n        return pathExt.map((ext) => exposePath + `.prefetch${ext}`);\n    }\n};\n","import path from 'path';\nimport fs from 'fs-extra';\nimport { bindLoggerToCompiler, createInfrastructureLogger, createLogger, encodeName, MFPrefetchCommon, } from '@module-federation/sdk';\nimport { normalizeWebpackPath } from '@module-federation/sdk/normalize-webpack-path';\nimport { TEMP_DIR } from '../common/constant';\nimport { fileExistsWithCaseSync, fixPrefetchPath } from '../common/node-utils';\nimport { getPrefetchId } from '../common/runtime-utils';\nimport { SHARED_STRATEGY } from '../constant';\nconst { RuntimeGlobals, Template } = require(normalizeWebpackPath('webpack'));\nconst createBundlerLogger = typeof createInfrastructureLogger === 'function'\n    ? createInfrastructureLogger\n    : createLogger;\nconst logger = createBundlerLogger('[ Module Federation Data Prefetch Plugin ]');\nexport function getFederationGlobalScope(runtimeGlobals) {\n    return `${runtimeGlobals.require || '__webpack_require__'}.federation`;\n}\nexport class PrefetchPlugin {\n    constructor(options) {\n        this.options = options;\n        this._reWriteExports = '';\n    }\n    apply(compiler) {\n        var _a;\n        bindLoggerToCompiler(logger, compiler, 'PrefetchPlugin');\n        const { name, exposes } = this.options;\n        if (!exposes) {\n            return;\n        }\n        if (!compiler.options.context) {\n            throw new Error('compiler.options.context is not defined');\n        }\n        const { runtimePlugins } = this.options;\n        if (!Array.isArray(runtimePlugins)) {\n            this.options.runtimePlugins = [];\n        }\n        const runtimePath = path.resolve(__dirname, './plugin.esm.js');\n        if (!((_a = this.options.runtimePlugins) === null || _a === void 0 ? void 0 : _a.includes(runtimePath))) {\n            this.options.runtimePlugins.push(runtimePath);\n        }\n        if (this.options.shareStrategy !== SHARED_STRATEGY) {\n            this.options.shareStrategy = SHARED_STRATEGY;\n            logger.warn(`[Module Federation Data Prefetch]: Your shared strategy is set to '${SHARED_STRATEGY}', this is a necessary condition for data prefetch`);\n        }\n        const encodedName = encodeName(name);\n        const asyncEntryPath = path.resolve(compiler.options.context, `node_modules/${TEMP_DIR}/${encodedName}/bootstrap.js`);\n        if (fs.existsSync(asyncEntryPath)) {\n            fs.unlinkSync(asyncEntryPath);\n        }\n        if (!this.options.dataPrefetch) {\n            return;\n        }\n        const prefetchs = [];\n        const exposeAlias = Object.keys(exposes);\n        exposeAlias.forEach((alias) => {\n            let exposePath;\n            const exposeValue = exposes[alias];\n            if (typeof exposeValue === 'string') {\n                exposePath = exposeValue;\n            }\n            else {\n                exposePath = exposeValue.import[0];\n            }\n            const targetPaths = fixPrefetchPath(exposePath);\n            for (const pathItem of targetPaths) {\n                const absolutePath = path.resolve(compiler.options.context, pathItem);\n                if (fileExistsWithCaseSync(absolutePath)) {\n                    prefetchs.push(pathItem);\n                    const absoluteAlias = alias.replace('.', '');\n                    this._reWriteExports += `export * as ${getPrefetchId(`${name}${absoluteAlias}`)} from '${absolutePath}';\\n`;\n                    break;\n                }\n            }\n        });\n        if (!this._reWriteExports) {\n            return;\n        }\n        const tempDirRealPath = path.resolve(compiler.options.context, 'node_modules', TEMP_DIR);\n        if (!fs.existsSync(tempDirRealPath)) {\n            fs.mkdirSync(tempDirRealPath);\n        }\n        if (!fs.existsSync(`${tempDirRealPath}/${encodedName}`)) {\n            fs.mkdirSync(`${tempDirRealPath}/${encodedName}`);\n        }\n        fs.writeFileSync(asyncEntryPath, this._reWriteExports);\n        new compiler.webpack.DefinePlugin({\n            FederationDataPrefetch: JSON.stringify(asyncEntryPath),\n        }).apply(compiler);\n    }\n    static addRuntime(compiler, options) {\n        const encodedName = encodeName(options.name);\n        if (!compiler.options.context) {\n            throw new Error('compiler.options.context is not defined');\n        }\n        const prefetchEntry = path.resolve(compiler.options.context, `node_modules/.mf/${encodedName}/bootstrap.js`);\n        const federationGlobal = getFederationGlobalScope(RuntimeGlobals || {});\n        return Template.asString([\n            fs.existsSync(prefetchEntry)\n                ? Template.indent([\n                    'function injectPrefetch() {',\n                    Template.indent([\n                        `globalThis.__FEDERATION__ = globalThis.__FEDERATION__ || {};`,\n                        `globalThis.__FEDERATION__['${MFPrefetchCommon.globalKey}'] = globalThis.__FEDERATION__['${MFPrefetchCommon.globalKey}'] || {`,\n                        `entryLoading: {},`,\n                        `instance: new Map(),`,\n                        `__PREFETCH_EXPORTS__: {},`,\n                        `};`,\n                        `globalThis.__FEDERATION__['${MFPrefetchCommon.globalKey}']['${MFPrefetchCommon.exportsKey}'] = globalThis.__FEDERATION__['${MFPrefetchCommon.globalKey}']['${MFPrefetchCommon.exportsKey}'] || {};`,\n                        `globalThis.__FEDERATION__['${MFPrefetchCommon.globalKey}']['${MFPrefetchCommon.exportsKey}']['${options.name}'] = function(){ return import('${prefetchEntry}');}`,\n                    ]),\n                    '}',\n                    `${federationGlobal}.prefetch = injectPrefetch`,\n                ])\n                : '',\n            Template.indent([\n                `if(!${federationGlobal}.isMFRemote && ${federationGlobal}.prefetch){`,\n                `${federationGlobal}.prefetch()`,\n                '}',\n            ]),\n        ]);\n    }\n    static setRemoteIdentifier() {\n        const federationGlobal = getFederationGlobalScope(RuntimeGlobals || {});\n        return Template.indent([`${federationGlobal}.isMFRemote = true;`]);\n    }\n    static removeRemoteIdentifier() {\n        const federationGlobal = getFederationGlobalScope(RuntimeGlobals || {});\n        return Template.indent([`${federationGlobal}.isMFRemote = false;`]);\n    }\n}\n"],"names":[],"mappings":";;;;;;;AAAO,MAAM,QAAQ,GAAG,KAAK;;ACEtB,MAAM,sBAAsB,GAAG,CAAC,QAAQ,KAAK;AACpD,IAAI,MAAM,GAAG,GAAG,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC;AACtC,IAAI,IAAI,QAAQ,KAAK,GAAG,IAAI,QAAQ,KAAK,GAAG,EAAE;AAC9C,QAAQ,OAAO,IAAI;AACnB;AACA,IAAI,MAAM,SAAS,GAAG,EAAE,CAAC,WAAW,CAAC,GAAG,CAAC;AACzC,IAAI,IAAI,SAAS,CAAC,OAAO,CAAC,IAAI,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC,KAAK,EAAE,EAAE;AAC3D,QAAQ,OAAO,KAAK;AACpB;AACA,IAAI,OAAO,sBAAsB,CAAC,GAAG,CAAC;AACtC,CAAC;AACM,MAAM,eAAe,GAAG,CAAC,UAAU,KAAK;AAC/C,IAAI,MAAM,OAAO,GAAG,CAAC,KAAK,EAAE,KAAK,CAAC;AAClC,IAAI,MAAM,MAAM,GAAG,oBAAoB;AACvC,IAAI,IAAI,MAAM,CAAC,IAAI,CAAC,UAAU,CAAC,EAAE;AACjC,QAAQ,OAAO,OAAO,CAAC,GAAG,CAAC,CAAC,GAAG,KAAK,UAAU,CAAC,OAAO,CAAC,MAAM,EAAE,CAAC,SAAS,EAAE,GAAG,CAAC,CAAC,CAAC,CAAC;AAClF;AACA,SAAS;AACT,QAAQ,OAAO,OAAO,CAAC,GAAG,CAAC,CAAC,GAAG,KAAK,UAAU,GAAG,CAAC,SAAS,EAAE,GAAG,CAAC,CAAC,CAAC;AACnE;AACA,CAAC;;ACdD,MAAM,EAAE,cAAc,EAAE,QAAQ,EAAE,GAAG,OAAO,CAAC,oBAAoB,CAAC,SAAS,CAAC,CAAC;AAC7E,MAAM,mBAAmB,GAAG,OAAO,0BAA0B,KAAK;AAClE,MAAM;AACN,MAAM,YAAY;AAClB,MAAM,MAAM,GAAG,mBAAmB,CAAC,4CAA4C,CAAC;AACzE,SAAS,wBAAwB,CAAC,cAAc,EAAE;AACzD,IAAI,OAAO,CAAC,EAAE,cAAc,CAAC,OAAO,IAAI,qBAAqB,CAAC,WAAW,CAAC;AAC1E;AACO,MAAM,cAAc,CAAC;AAC5B,IAAI,WAAW,CAAC,OAAO,EAAE;AACzB,QAAQ,IAAI,CAAC,OAAO,GAAG,OAAO;AAC9B,QAAQ,IAAI,CAAC,eAAe,GAAG,EAAE;AACjC;AACA,IAAI,KAAK,CAAC,QAAQ,EAAE;AACpB,QAAQ,IAAI,EAAE;AACd,QAAQ,oBAAoB,CAAC,MAAM,EAAE,QAAQ,EAAE,gBAAgB,CAAC;AAChE,QAAQ,MAAM,EAAE,IAAI,EAAE,OAAO,EAAE,GAAG,IAAI,CAAC,OAAO;AAC9C,QAAQ,IAAI,CAAC,OAAO,EAAE;AACtB,YAAY;AACZ;AACA,QAAQ,IAAI,CAAC,QAAQ,CAAC,OAAO,CAAC,OAAO,EAAE;AACvC,YAAY,MAAM,IAAI,KAAK,CAAC,yCAAyC,CAAC;AACtE;AACA,QAAQ,MAAM,EAAE,cAAc,EAAE,GAAG,IAAI,CAAC,OAAO;AAC/C,QAAQ,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,cAAc,CAAC,EAAE;AAC5C,YAAY,IAAI,CAAC,OAAO,CAAC,cAAc,GAAG,EAAE;AAC5C;AACA,QAAQ,MAAM,WAAW,GAAG,IAAI,CAAC,OAAO,CAAC,SAAS,EAAE,iBAAiB,CAAC;AACtE,QAAQ,IAAI,EAAE,CAAC,EAAE,GAAG,IAAI,CAAC,OAAO,CAAC,cAAc,MAAM,IAAI,IAAI,EAAE,KAAK,MAAM,GAAG,MAAM,GAAG,EAAE,CAAC,QAAQ,CAAC,WAAW,CAAC,CAAC,EAAE;AACjH,YAAY,IAAI,CAAC,OAAO,CAAC,cAAc,CAAC,IAAI,CAAC,WAAW,CAAC;AACzD;AACA,QAAQ,IAAI,IAAI,CAAC,OAAO,CAAC,aAAa,KAAK,eAAe,EAAE;AAC5D,YAAY,IAAI,CAAC,OAAO,CAAC,aAAa,GAAG,eAAe;AACxD,YAAY,MAAM,CAAC,IAAI,CAAC,CAAC,mEAAmE,EAAE,eAAe,CAAC,kDAAkD,CAAC,CAAC;AAClK;AACA,QAAQ,MAAM,WAAW,GAAG,UAAU,CAAC,IAAI,CAAC;AAC5C,QAAQ,MAAM,cAAc,GAAG,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,OAAO,CAAC,OAAO,EAAE,CAAC,aAAa,EAAE,QAAQ,CAAC,CAAC,EAAE,WAAW,CAAC,aAAa,CAAC,CAAC;AAC7H,QAAQ,IAAI,EAAE,CAAC,UAAU,CAAC,cAAc,CAAC,EAAE;AAC3C,YAAY,EAAE,CAAC,UAAU,CAAC,cAAc,CAAC;AACzC;AACA,QAAQ,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,YAAY,EAAE;AACxC,YAAY;AACZ;AAEA,QAAQ,MAAM,WAAW,GAAG,MAAM,CAAC,IAAI,CAAC,OAAO,CAAC;AAChD,QAAQ,WAAW,CAAC,OAAO,CAAC,CAAC,KAAK,KAAK;AACvC,YAAY,IAAI,UAAU;AAC1B,YAAY,MAAM,WAAW,GAAG,OAAO,CAAC,KAAK,CAAC;AAC9C,YAAY,IAAI,OAAO,WAAW,KAAK,QAAQ,EAAE;AACjD,gBAAgB,UAAU,GAAG,WAAW;AACxC;AACA,iBAAiB;AACjB,gBAAgB,UAAU,GAAG,WAAW,CAAC,MAAM,CAAC,CAAC,CAAC;AAClD;AACA,YAAY,MAAM,WAAW,GAAG,eAAe,CAAC,UAAU,CAAC;AAC3D,YAAY,KAAK,MAAM,QAAQ,IAAI,WAAW,EAAE;AAChD,gBAAgB,MAAM,YAAY,GAAG,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,OAAO,CAAC,OAAO,EAAE,QAAQ,CAAC;AACrF,gBAAgB,IAAI,sBAAsB,CAAC,YAAY,CAAC,EAAE;AAE1D,oBAAoB,MAAM,aAAa,GAAG,KAAK,CAAC,OAAO,CAAC,GAAG,EAAE,EAAE,CAAC;AAChE,oBAAoB,IAAI,CAAC,eAAe,IAAI,CAAC,YAAY,EAAE,aAAa,CAAC,CAAC,EAAE,IAAI,CAAC,EAAE,aAAa,CAAC,CAAC,CAAC,CAAC,OAAO,EAAE,YAAY,CAAC,IAAI,CAAC;AAC/H,oBAAoB;AACpB;AACA;AACA,SAAS,CAAC;AACV,QAAQ,IAAI,CAAC,IAAI,CAAC,eAAe,EAAE;AACnC,YAAY;AACZ;AACA,QAAQ,MAAM,eAAe,GAAG,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,OAAO,CAAC,OAAO,EAAE,cAAc,EAAE,QAAQ,CAAC;AAChG,QAAQ,IAAI,CAAC,EAAE,CAAC,UAAU,CAAC,eAAe,CAAC,EAAE;AAC7C,YAAY,EAAE,CAAC,SAAS,CAAC,eAAe,CAAC;AACzC;AACA,QAAQ,IAAI,CAAC,EAAE,CAAC,UAAU,CAAC,CAAC,EAAE,eAAe,CAAC,CAAC,EAAE,WAAW,CAAC,CAAC,CAAC,EAAE;AACjE,YAAY,EAAE,CAAC,SAAS,CAAC,CAAC,EAAE,eAAe,CAAC,CAAC,EAAE,WAAW,CAAC,CAAC,CAAC;AAC7D;AACA,QAAQ,EAAE,CAAC,aAAa,CAAC,cAAc,EAAE,IAAI,CAAC,eAAe,CAAC;AAC9D,QAAQ,IAAI,QAAQ,CAAC,OAAO,CAAC,YAAY,CAAC;AAC1C,YAAY,sBAAsB,EAAE,IAAI,CAAC,SAAS,CAAC,cAAc,CAAC;AAClE,SAAS,CAAC,CAAC,KAAK,CAAC,QAAQ,CAAC;AAC1B;AACA,IAAI,OAAO,UAAU,CAAC,QAAQ,EAAE,OAAO,EAAE;AACzC,QAAQ,MAAM,WAAW,GAAG,UAAU,CAAC,OAAO,CAAC,IAAI,CAAC;AACpD,QAAQ,IAAI,CAAC,QAAQ,CAAC,OAAO,CAAC,OAAO,EAAE;AACvC,YAAY,MAAM,IAAI,KAAK,CAAC,yCAAyC,CAAC;AACtE;AACA,QAAQ,MAAM,aAAa,GAAG,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,OAAO,CAAC,OAAO,EAAE,CAAC,iBAAiB,EAAE,WAAW,CAAC,aAAa,CAAC,CAAC;AACpH,QAAQ,MAAM,gBAAgB,GAAG,wBAAwB,CAAC,cAAc,IAAI,EAAE,CAAC;AAC/E,QAAQ,OAAO,QAAQ,CAAC,QAAQ,CAAC;AACjC,YAAY,EAAE,CAAC,UAAU,CAAC,aAAa;AACvC,kBAAkB,QAAQ,CAAC,MAAM,CAAC;AAClC,oBAAoB,6BAA6B;AACjD,oBAAoB,QAAQ,CAAC,MAAM,CAAC;AACpC,wBAAwB,CAAC,4DAA4D,CAAC;AACtF,wBAAwB,CAAC,2BAA2B,EAAE,gBAAgB,CAAC,SAAS,CAAC,gCAAgC,EAAE,gBAAgB,CAAC,SAAS,CAAC,OAAO,CAAC;AACtJ,wBAAwB,CAAC,iBAAiB,CAAC;AAC3C,wBAAwB,CAAC,oBAAoB,CAAC;AAC9C,wBAAwB,CAAC,yBAAyB,CAAC;AACnD,wBAAwB,CAAC,EAAE,CAAC;AAC5B,wBAAwB,CAAC,2BAA2B,EAAE,gBAAgB,CAAC,SAAS,CAAC,IAAI,EAAE,gBAAgB,CAAC,UAAU,CAAC,gCAAgC,EAAE,gBAAgB,CAAC,SAAS,CAAC,IAAI,EAAE,gBAAgB,CAAC,UAAU,CAAC,SAAS,CAAC;AAC5N,wBAAwB,CAAC,2BAA2B,EAAE,gBAAgB,CAAC,SAAS,CAAC,IAAI,EAAE,gBAAgB,CAAC,UAAU,CAAC,IAAI,EAAE,OAAO,CAAC,IAAI,CAAC,gCAAgC,EAAE,aAAa,CAAC,IAAI,CAAC;AAC3L,qBAAqB,CAAC;AACtB,oBAAoB,GAAG;AACvB,oBAAoB,CAAC,EAAE,gBAAgB,CAAC,0BAA0B,CAAC;AACnE,iBAAiB;AACjB,kBAAkB,EAAE;AACpB,YAAY,QAAQ,CAAC,MAAM,CAAC;AAC5B,gBAAgB,CAAC,IAAI,EAAE,gBAAgB,CAAC,eAAe,EAAE,gBAAgB,CAAC,WAAW,CAAC;AACtF,gBAAgB,CAAC,EAAE,gBAAgB,CAAC,WAAW,CAAC;AAChD,gBAAgB,GAAG;AACnB,aAAa,CAAC;AACd,SAAS,CAAC;AACV;AACA,IAAI,OAAO,mBAAmB,GAAG;AACjC,QAAQ,MAAM,gBAAgB,GAAG,wBAAwB,CAAC,cAAc,IAAI,EAAE,CAAC;AAC/E,QAAQ,OAAO,QAAQ,CAAC,MAAM,CAAC,CAAC,CAAC,EAAE,gBAAgB,CAAC,mBAAmB,CAAC,CAAC,CAAC;AAC1E;AACA,IAAI,OAAO,sBAAsB,GAAG;AACpC,QAAQ,MAAM,gBAAgB,GAAG,wBAAwB,CAAC,cAAc,IAAI,EAAE,CAAC;AAC/E,QAAQ,OAAO,QAAQ,CAAC,MAAM,CAAC,CAAC,CAAC,EAAE,gBAAgB,CAAC,oBAAoB,CAAC,CAAC,CAAC;AAC3E;AACA;;;;"}